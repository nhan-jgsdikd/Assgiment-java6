<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{/Navar/Layout :: view(~{::main})}">
<body>
    <main class="content">
        <link rel="stylesheet" href="css/Editproducts.css">
    <div class="container mt-5">
        <h1 class="text-center">Quản lý sản phẩm</h1>
        <button class="btn btn-primary mb-3" onclick="openAddModal()">Thêm sản phẩm</button>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Tên sản phẩm</th>
                    <th>Giá</th>
                    <th>Mô tả</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                <!-- Dữ liệu sản phẩm sẽ được thêm vào đây bằng JavaScript -->
            </tbody>
        </table>
    </div>

    <!-- Modal thêm sản phẩm -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addProductModalLabel">Thêm sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm">
                        <div class="mb-3">
                            <label for="productName" class="form-label">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="mb-3">
                            <label for="productPrice" class="form-label">Giá</label>
                            <input type="number" class="form-control" id="productPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="productDescription" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="productDescription" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="addProduct()">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal chỉnh sửa sản phẩm -->
    <div class="modal fade" id="editProductModal" tabindex="-1" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductModalLabel">Chỉnh sửa sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProductForm">
                        <input type="hidden" id="editProductId">
                        <div class="mb-3">
                            <label for="editProductName" class="form-label">Tên sản phẩm</label>
                            <input type="text" class="form-control" id="editProductName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductPrice" class="form-label">Giá</label>
                            <input type="number" class="form-control" id="editProductPrice" required>
                        </div>
                        <div class="mb-3">
                            <label for="editProductDescription" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="editProductDescription" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="updateProduct()">Cập nhật</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load dữ liệu sản phẩm khi trang được tải
        document.addEventListener('DOMContentLoaded', fetchProducts);

        // Lấy danh sách sản phẩm từ backend
        async function fetchProducts() {
            const response = await fetch('/api/products');
            const products = await response.json();
            renderProducts(products);
        }

        // Hiển thị danh sách sản phẩm
        function renderProducts(products) {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            products.forEach(product => {
                const row = `
                    <tr>
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.price}</td>
                        <td>${product.description}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="openEditModal(${product.id})">Sửa</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteProduct(${product.id})">Xóa</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Mở modal thêm sản phẩm
        function openAddModal() {
            document.getElementById('addProductForm').reset();
            new bootstrap.Modal(document.getElementById('addProductModal')).show();
        }

        // Thêm sản phẩm
        async function addProduct() {
            const productName = document.getElementById('productName').value;
            const productPrice = document.getElementById('productPrice').value;
            const productDescription = document.getElementById('productDescription').value;

            const response = await fetch('/api/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: productName, price: productPrice, description: productDescription })
            });

            if (response.ok) {
                fetchProducts();
                bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
            }
        }

        // Mở modal chỉnh sửa sản phẩm
        async function openEditModal(id) {
            const response = await fetch(`/api/products/${id}`);
            const product = await response.json();

            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductDescription').value = product.description;

            new bootstrap.Modal(document.getElementById('editProductModal')).show();
        }

        // Cập nhật sản phẩm
        async function updateProduct() {
            const id = document.getElementById('editProductId').value;
            const productName = document.getElementById('editProductName').value;
            const productPrice = document.getElementById('editProductPrice').value;
            const productDescription = document.getElementById('editProductDescription').value;

            const response = await fetch(`/api/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: productName, price: productPrice, description: productDescription })
            });

            if (response.ok) {
                fetchProducts();
                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            }
        }

        // Xóa sản phẩm
        async function deleteProduct(id) {
            const response = await fetch(`/api/products/${id}`, { method: 'DELETE' });
            if (response.ok) {
                fetchProducts();
            }
        }
    </script>
    </main>
</body>
</html>